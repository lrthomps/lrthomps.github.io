{"title":"GPU for ML only on Ubuntu","markdown":{"yaml":{"title":"GPU for ML only on Ubuntu","categories":["other"],"date":"2020-09-11","description":"To go against the grain, you have to fight."},"containsRefs":false,"markdown":"\n\n\nI fought with NVIDIA drivers taking over my graphics and xterm on Ubuntu 20.04. It was either have my GPU do everything and lose up to half its memory in the process... or nothing. I had it working once... then updates uninstalled the driver and broke everything again.\n\nThat was a few weeks ago. I'm confident now, a few updates later, that I'm using the correct driver and that settings are all good, so I'll document what it took. Some may be unnecessary steps but since I got it working once and haven't experimented further, I can't say.\n\n* in BIOS settings, I had to enable `iGPU multi-monitor` and enable `CPUgraphics`\n\n* install CUDA tools\n\n  ```bash\n  sudo apt install nvidia-cuda-toolkit\n  ```\n\n  \n\n* install cudnn from NVIDIA; requires an account\n\n* install a *headless* driver and accompanying utils\n\n  ```bash\n  sudo apt install nvidia-headless-440 nvidia-utils-440\n  ```\n\n  \n\n* add to PATH and LD_LIBRARY_PATH in .bashrc\n\n  ```bash\n  export PATH=/usr/local/cuda/bin${PATH:+:${PATH}}\n  export LD_LIBRARY_PATH=/usr/local/cuda/lib64\n  ```\n\n  \n\n* create a new config file in `/etc/X11/xorg.conf` with settings\n\n  ```\n  Section \"ServerLayout\"\n      Identifier     \"Layout0\"\n      Screen      0  \"Screen0\"\n  EndSection\n  \n  Section \"Screen\"\n      Identifier     \"Screen0\"\n      Device         \"intel\"\n  EndSection\n  \n  Section \"Device\"\n      Identifier      \"intel\"\n      Driver          \"intel\"\n      VendorName      \"Intel Corporation\"\n      BusId           \"PCI:0:2:0\"\n      Option \"AccelMethod\" \"sna\"\n      Option \"TearFree\" \"true\"\n      Option \"DRI\" \"3\"\n  EndSection\n  ```\n\n  \n\n* modify grub settings in `/etc/default/grub` so that \n\n  ```\n  GRUB_CMDLINE_LINUX=\"nogpumanager\"\n  ```\n\n  then run `sudo update-grub` for the settings to take effect\n\n* if, in the process, the file `/usr/share/X11/xorg.conf.d/11-nvidia-prime.conf` was created: delete it\n\n* finally, last but not least, following random/good internet [advice](http://litaotju.github.io/2019/03/13/=Use-intel-for-display-nvidia-for-computing/), add (create?) the following to `/etc/modprobe.d/blacklist-nvidia.conf`\n\n  ```\n  blacklist nvidia-drm\n  alias nvidia-drm off\n  ```\n\n  \n\nNow all should be working. To be sure, running `nvidia-smi` should show something like  \n\n```\nFri Sep 11 19:45:45 2020       \n+-----------------------------------------------------------------------------+\n| NVIDIA-SMI 450.66       Driver Version: 450.66       CUDA Version: 11.0     |\n|-------------------------------+----------------------+----------------------+\n| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\n| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\n|                               |                      |               MIG M. |\n|===============================+======================+======================|\n|   0  GeForce RTX 2070    Off  | 00000000:02:00.0 Off |                  N/A |\n| 35%   47C    P0    22W / 175W |      0MiB /  7982MiB |      0%      Default |\n|                               |                      |                  N/A |\n+-------------------------------+----------------------+----------------------+\n                                                                               \n+-----------------------------------------------------------------------------+\n| Processes:                                                                  |\n|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |\n|        ID   ID                                                   Usage      |\n|=============================================================================|\n|  No running processes found                                                 |\n+-----------------------------------------------------------------------------+\n```\n\nAnd, in e.g. a jupyter notebook, running `tf.config.list_physical_devices('GPU')` should output the \n\n```\n[PhysicalDevice(name='/physical_device:GPU:0', device_type='GPU')]\n```\n\nEureka! All the memory for ML!","srcMarkdownNoYaml":"\n\n\nI fought with NVIDIA drivers taking over my graphics and xterm on Ubuntu 20.04. It was either have my GPU do everything and lose up to half its memory in the process... or nothing. I had it working once... then updates uninstalled the driver and broke everything again.\n\nThat was a few weeks ago. I'm confident now, a few updates later, that I'm using the correct driver and that settings are all good, so I'll document what it took. Some may be unnecessary steps but since I got it working once and haven't experimented further, I can't say.\n\n* in BIOS settings, I had to enable `iGPU multi-monitor` and enable `CPUgraphics`\n\n* install CUDA tools\n\n  ```bash\n  sudo apt install nvidia-cuda-toolkit\n  ```\n\n  \n\n* install cudnn from NVIDIA; requires an account\n\n* install a *headless* driver and accompanying utils\n\n  ```bash\n  sudo apt install nvidia-headless-440 nvidia-utils-440\n  ```\n\n  \n\n* add to PATH and LD_LIBRARY_PATH in .bashrc\n\n  ```bash\n  export PATH=/usr/local/cuda/bin${PATH:+:${PATH}}\n  export LD_LIBRARY_PATH=/usr/local/cuda/lib64\n  ```\n\n  \n\n* create a new config file in `/etc/X11/xorg.conf` with settings\n\n  ```\n  Section \"ServerLayout\"\n      Identifier     \"Layout0\"\n      Screen      0  \"Screen0\"\n  EndSection\n  \n  Section \"Screen\"\n      Identifier     \"Screen0\"\n      Device         \"intel\"\n  EndSection\n  \n  Section \"Device\"\n      Identifier      \"intel\"\n      Driver          \"intel\"\n      VendorName      \"Intel Corporation\"\n      BusId           \"PCI:0:2:0\"\n      Option \"AccelMethod\" \"sna\"\n      Option \"TearFree\" \"true\"\n      Option \"DRI\" \"3\"\n  EndSection\n  ```\n\n  \n\n* modify grub settings in `/etc/default/grub` so that \n\n  ```\n  GRUB_CMDLINE_LINUX=\"nogpumanager\"\n  ```\n\n  then run `sudo update-grub` for the settings to take effect\n\n* if, in the process, the file `/usr/share/X11/xorg.conf.d/11-nvidia-prime.conf` was created: delete it\n\n* finally, last but not least, following random/good internet [advice](http://litaotju.github.io/2019/03/13/=Use-intel-for-display-nvidia-for-computing/), add (create?) the following to `/etc/modprobe.d/blacklist-nvidia.conf`\n\n  ```\n  blacklist nvidia-drm\n  alias nvidia-drm off\n  ```\n\n  \n\nNow all should be working. To be sure, running `nvidia-smi` should show something like  \n\n```\nFri Sep 11 19:45:45 2020       \n+-----------------------------------------------------------------------------+\n| NVIDIA-SMI 450.66       Driver Version: 450.66       CUDA Version: 11.0     |\n|-------------------------------+----------------------+----------------------+\n| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\n| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\n|                               |                      |               MIG M. |\n|===============================+======================+======================|\n|   0  GeForce RTX 2070    Off  | 00000000:02:00.0 Off |                  N/A |\n| 35%   47C    P0    22W / 175W |      0MiB /  7982MiB |      0%      Default |\n|                               |                      |                  N/A |\n+-------------------------------+----------------------+----------------------+\n                                                                               \n+-----------------------------------------------------------------------------+\n| Processes:                                                                  |\n|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |\n|        ID   ID                                                   Usage      |\n|=============================================================================|\n|  No running processes found                                                 |\n+-----------------------------------------------------------------------------+\n```\n\nAnd, in e.g. a jupyter notebook, running `tf.config.list_physical_devices('GPU')` should output the \n\n```\n[PhysicalDevice(name='/physical_device:GPU:0', device_type='GPU')]\n```\n\nEureka! All the memory for ML!"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../styles.css"],"output-file":"gpu-for-ml-only.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.5.56","theme":{"light":"cosmo","dark":["cosmo","../theme-dark.scss"]},"max-width":"500px","title-block-banner":true,"author":"Lara Thompson","title":"GPU for ML only on Ubuntu","categories":["other"],"date":"2020-09-11","description":"To go against the grain, you have to fight."},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}